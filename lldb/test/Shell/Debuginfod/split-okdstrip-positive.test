# REQUIRES: curl && system-linux && native && target-x86_64

# Scenario 5:
# * A stripped, split binary, with --add-gnu-debuglink symbol file where
# * both files are *only* available through Debuginfod.

# Set up a file-system 'hosted' Debuginfod server
# RUN: rm -rf %t
# RUN: mkdir -p %t/cache
# RUN: mkdir -p %t/buildid/82b2c35129dab19ad58f3dd0f426bdb0cc8aa094

# RUN: yaml2obj %p/Inputs/bin-split-stripped.yaml -o %t/bin-split-stripped.tmp
# RUN: yaml2obj %p/Inputs/sym-split.yaml -o %t/sym-split
# RUN: llvm-objcopy %t/bin-split-stripped.tmp --add-gnu-debuglink=%t/sym-split %t/bin-split-stripped
# RUN: mv %t/sym-split %t/buildid/82b2c35129dab19ad58f3dd0f426bdb0cc8aa094/executable
# RUN: yaml2obj %p/Inputs/bin-split-dwp.yaml -o %t/buildid/82b2c35129dab19ad58f3dd0f426bdb0cc8aa094/debuginfo
# RUN: chmod a+x %t/bin-split-stripped

# RUN: %lldb -o "settings set symbols.enable-external-lookup true" \
# RUN:       -o "settings set plugin.symbol-locator.debuginfod.cache-path %t/cache" \
# RUN:       -o "settings clear plugin.symbol-locator.debuginfod.server-urls" \
# RUN:       -o "settings insert-before plugin.symbol-locator.debuginfod.server-urls 0 file://%t" \
# RUN:       -o "target create %t/bin-split-stripped" \
# RUN:       -o "target modules dump separate-debug-info" \
# RUN:       -o "quit" \
# RUN:        2>&1 | FileCheck %s

# CHECK: Symbol file: {{.*}}/bin-split-stripped
# CHECK-NEXT: Type: "dwo"
# CHECK-NEXT: Dwo ID{{.*}}
# CHECK-NEXT: {{[- ]+}}
# CHECK-NEXT: {{0x[0-9a-f]+.* +.*}}.tmp/cache/llvmcache-6559017670391320133{{ *$}}
