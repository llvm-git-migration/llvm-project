; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 5
; RUN: llc < %s -mtriple=i386-pc-windows-msvc --frame-pointer=all | FileCheck %s

; ISel will try to fold pointer arithmetic into the address displacement. However, we don't
; want to do that if the offset is very close to the expressible limit because the final frame
; layout may push it over/under the limit.

define i32 @foo(i1 %b) #0 {
; CHECK-LABEL: foo:
; CHECK:       # %bb.0: # %entry
; CHECK-NEXT:    pushl %ebp
; CHECK-NEXT:    movl %esp, %ebp
; CHECK-NEXT:    pushl %esi
; CHECK-NEXT:    subl $8, %esp
; CHECK-NEXT:    movl ___security_cookie, %eax
; CHECK-NEXT:    xorl %ebp, %eax
; CHECK-NEXT:    movl %eax, -8(%ebp)
; CHECK-NEXT:    testb $1, 8(%ebp)
; CHECK-NEXT:    jne LBB0_1
; CHECK-NEXT:  # %bb.2: # %entry
; CHECK-NEXT:    xorl %esi, %esi
; CHECK-NEXT:    jmp LBB0_3
; CHECK-NEXT:  LBB0_1:
; CHECK-NEXT:    leal 2147483640(%ebp), %esi
; CHECK-NEXT:  LBB0_3: # %entry
; CHECK-NEXT:    movl -8(%ebp), %ecx
; CHECK-NEXT:    xorl %ebp, %ecx
; CHECK-NEXT:    calll @__security_check_cookie@4
; CHECK-NEXT:    movl %esi, %eax
; CHECK-NEXT:    addl $8, %esp
; CHECK-NEXT:    popl %esi
; CHECK-NEXT:    popl %ebp
; CHECK-NEXT:    retl
entry:
  %a = alloca i8, align 1
  %0 = ptrtoint ptr %a to i32
  %sub = add i32 %0, -2147483647
  %retval.0 = select i1 %b, i32 %sub, i32 0
  ret i32 %retval.0
}

attributes #0 = { sspreq }
