# NOTE: Assertions have been autogenerated by utils/update_mir_test_checks.py
# RUN: llc -mtriple powerpc64le-unknown-linux-gnu -mcpu=pwr8 -mattr=-altivec \
# RUN: -run-pass=prologepilog --verify-machineinstrs %s -o - | \
# RUN: FileCheck %s --check-prefixes=SAVEONE

# RUN: llc -mtriple powerpc64-unknown-linux-gnu -mcpu=pwr7 -mattr=-altivec \
# RUN: -run-pass=prologepilog --verify-machineinstrs %s -o - | \
# RUN: FileCheck %s --check-prefixes=SAVEALL


# RUN: llc -mtriple powerpc64-unknown-aix-xcoff -mcpu=pwr4 -mattr=-altivec \
# RUN: -run-pass=prologepilog --verify-machineinstrs %s -o - | \
# RUN: FileCheck %s --check-prefixes=SAVEALL-AIX

---
name:            CRAllSave
alignment:       16
tracksRegLiveness: true
liveins:
  - { reg: '$x3', virtual-reg: '' }
body:             |
  bb.0.entry:
    liveins: $x3
    ; SAVEONE-LABEL: name: CRAllSave
    ; SAVEONE: liveins: $x3, $x29, $cr2, $cr4
    ; SAVEONE: $x12 = MFCR8 implicit killed $cr2, implicit killed $cr4
    ; SAVEONE: STW8 killed $x12, 8, $x1
    ; SAVEONE: STD killed $x29, -24, $x1 :: (store (s64) into %fixed-stack.0)
    ; SAVEONE: renamable $x29 = ANDI8_rec killed renamable $x3, 1, implicit-def dead $cr0, implicit-def $cr0gt
    ; SAVEONE: renamable $cr2lt = COPY $cr0gt
    ; SAVEONE: renamable $cr4lt = COPY $cr0gt
    ; SAVEONE: renamable $x3 = COPY $x29
    ; SAVEONE: $x29 = LD -24, $x1 :: (load (s64) from %fixed-stack.0)
    ; SAVEONE: $x12 = LWZ8 8, $x1
    ; SAVEONE: $cr2 = MTOCRF8 $x12
    ; SAVEONE: $cr4 = MTOCRF8 killed $x12
    ; SAVEONE: BLR8 implicit $lr8, implicit $rm, implicit $x3
    ; SAVEALL-LABEL: name: CRAllSave
    ; SAVEALL: liveins: $x3, $x29, $cr2, $cr4
    ; SAVEALL: $x12 = MFCR8 implicit killed $cr2, implicit killed $cr4
    ; SAVEALL: STW8 killed $x12, 8, $x1
    ; SAVEALL: STD killed $x29, -24, $x1 :: (store (s64) into %fixed-stack.0)
    ; SAVEALL: renamable $x29 = ANDI8_rec killed renamable $x3, 1, implicit-def dead $cr0, implicit-def $cr0gt
    ; SAVEALL: renamable $cr2lt = COPY $cr0gt
    ; SAVEALL: renamable $cr4lt = COPY $cr0gt
    ; SAVEALL: renamable $x3 = COPY $x29
    ; SAVEALL: $x29 = LD -24, $x1 :: (load (s64) from %fixed-stack.0)
    ; SAVEALL: $x12 = LWZ8 8, $x1
    ; SAVEALL: $cr2 = MTOCRF8 $x12
    ; SAVEALL: $cr4 = MTOCRF8 killed $x12
    ; SAVEALL: BLR8 implicit $lr8, implicit $rm, implicit $x3
    ; SAVEALL-AIX-LABEL: name: CRAllSave
    ; SAVEALL-AIX: liveins: $x3, $x29, $x30, $x31, $cr2, $cr4
    ; SAVEALL-AIX: $x12 = MFCR8 implicit killed $cr2, implicit killed $cr4
    ; SAVEALL-AIX: STW8 killed $x12, 8, $x1
    ; SAVEALL-AIX: STD killed $x29, -24, $x1 :: (store (s64) into %fixed-stack.2)
    ; SAVEALL-AIX: STD killed $x30, -16, $x1 :: (store (s64) into %fixed-stack.1, align 16)
    ; SAVEALL-AIX: STD killed $x31, -8, $x1 :: (store (s64) into %fixed-stack.0)
    ; SAVEALL-AIX: renamable $x29 = ANDI8_rec killed renamable $x3, 1, implicit-def dead $cr0, implicit-def $cr0gt
    ; SAVEALL-AIX: renamable $cr2lt = COPY $cr0gt
    ; SAVEALL-AIX: renamable $cr4lt = COPY $cr0gt
    ; SAVEALL-AIX: renamable $x3 = COPY $x29
    ; SAVEALL-AIX: $x31 = LD -8, $x1 :: (load (s64) from %fixed-stack.0)
    ; SAVEALL-AIX: $x30 = LD -16, $x1 :: (load (s64) from %fixed-stack.1, align 16)
    ; SAVEALL-AIX: $x29 = LD -24, $x1 :: (load (s64) from %fixed-stack.2)
    ; SAVEALL-AIX: $x12 = LWZ8 8, $x1
    ; SAVEALL-AIX: $cr2 = MTOCRF8 $x12
    ; SAVEALL-AIX: $cr4 = MTOCRF8 killed $x12
    ; SAVEALL-AIX: BLR8 implicit $lr8, implicit $rm, implicit $x3
    renamable $x29 = ANDI8_rec killed renamable $x3, 1, implicit-def dead $cr0, implicit-def $cr0gt
    renamable $cr2lt = COPY $cr0gt
    renamable $cr4lt = COPY $cr0gt
    renamable $x3 = COPY $x29
    BLR8 implicit $lr8, implicit $rm, implicit $x3

    ; CHECK-LABEL: fixedStack:
    ; CHECK-NEXT:     - { id: 0, type: spill-slot, offset: -24, size: 8, alignment: 8, stack-id: default,
    ; CHECK-NEXT:         callee-saved-register: '$x29', callee-saved-restored: true, debug-info-variable: '',
    ; CHECK-NEXT:         debug-info-expression: '', debug-info-location: '' }
    ; CHECK-NEXT:     - { id: 1, type: default, offset: 8, size: 4, alignment: 8, stack-id: default,
    ; CHECK-NEXT:         isImmutable: true, isAliased: false, callee-saved-register: '$cr4',
    ; CHECK-NEXT:         callee-saved-restored: true, debug-info-variable: '', debug-info-expression: '',
    ; CHECK-NEXT:         debug-info-location: '' }
    ; CHECK-LABEL:  stack:

    ; Verify the proper live-ins have been added in the prologue.
    ; CHECK:    liveins: $x3, $x29, $cr2, $cr4

    ; CHECK:     $x12 = MFCR8 implicit killed $cr2, implicit killed $cr4
    ; CHECK-DAG: STD killed $x29, -24, $x1 :: (store (s64) into %fixed-stack.0)
    ; CHECK-DAG: STW8 killed $x12, 8, $x1

    ; CHECK:     $x29 = LD -24, $x1 :: (load (s64) from %fixed-stack.0)
    ; CHECK:     $x12 = LWZ8 8, $x1
    ; CHECK:     $cr2 = MTOCRF8 $x12
    ; CHECK:     $cr4 = MTOCRF8 killed $x12

...
---
name:            CR2Save
alignment:       16
tracksRegLiveness: true
liveins:
  - { reg: '$x3', virtual-reg: '' }
body:             |
  bb.0.entry:
    liveins: $x3
    ; SAVEONE-LABEL: name: CR2Save
    ; SAVEONE: liveins: $x3, $x14, $cr2
    ; SAVEONE: $x12 = MFOCRF8 killed $cr2
    ; SAVEONE: STW8 killed $x12, 8, $x1
    ; SAVEONE: STD killed $x14, -144, $x1 :: (store (s64) into %fixed-stack.0, align 16)
    ; SAVEONE: renamable $x14 = ANDI8_rec killed renamable $x3, 1, implicit-def dead $cr0, implicit-def $cr0gt
    ; SAVEONE: renamable $cr2lt = COPY $cr0gt
    ; SAVEONE: renamable $x3 = COPY $x14
    ; SAVEONE: $x14 = LD -144, $x1 :: (load (s64) from %fixed-stack.0, align 16)
    ; SAVEONE: $x12 = LWZ8 8, $x1
    ; SAVEONE: $cr2 = MTOCRF8 killed $x12
    ; SAVEONE: BLR8 implicit $lr8, implicit $rm, implicit $x3
    ; SAVEALL-LABEL: name: CR2Save
    ; SAVEALL: liveins: $x3, $x14, $cr2
    ; SAVEALL: $x12 = MFCR8 implicit killed $cr2
    ; SAVEALL: STW8 killed $x12, 8, $x1
    ; SAVEALL: STD killed $x14, -144, $x1 :: (store (s64) into %fixed-stack.0, align 16)
    ; SAVEALL: renamable $x14 = ANDI8_rec killed renamable $x3, 1, implicit-def dead $cr0, implicit-def $cr0gt
    ; SAVEALL: renamable $cr2lt = COPY $cr0gt
    ; SAVEALL: renamable $x3 = COPY $x14
    ; SAVEALL: $x14 = LD -144, $x1 :: (load (s64) from %fixed-stack.0, align 16)
    ; SAVEALL: $x12 = LWZ8 8, $x1
    ; SAVEALL: $cr2 = MTOCRF8 killed $x12
    ; SAVEALL: BLR8 implicit $lr8, implicit $rm, implicit $x3
    ; SAVEALL-AIX-LABEL: name: CR2Save
    ; SAVEALL-AIX: liveins: $x3, $x14, $x15, $x16, $x17, $x18, $x19, $x20, $x21, $x22, $x23, $x24, $x25, $x26, $x27, $x28, $x29, $x30, $x31, $cr2
    ; SAVEALL-AIX: $x12 = MFCR8 implicit killed $cr2
    ; SAVEALL-AIX: STW8 killed $x12, 8, $x1
    ; SAVEALL-AIX: STD killed $x14, -144, $x1 :: (store (s64) into %fixed-stack.17, align 16)
    ; SAVEALL-AIX: STD killed $x15, -136, $x1 :: (store (s64) into %fixed-stack.16)
    ; SAVEALL-AIX: STD killed $x16, -128, $x1 :: (store (s64) into %fixed-stack.15, align 16)
    ; SAVEALL-AIX: STD killed $x17, -120, $x1 :: (store (s64) into %fixed-stack.14)
    ; SAVEALL-AIX: STD killed $x18, -112, $x1 :: (store (s64) into %fixed-stack.13, align 16)
    ; SAVEALL-AIX: STD killed $x19, -104, $x1 :: (store (s64) into %fixed-stack.12)
    ; SAVEALL-AIX: STD killed $x20, -96, $x1 :: (store (s64) into %fixed-stack.11, align 16)
    ; SAVEALL-AIX: STD killed $x21, -88, $x1 :: (store (s64) into %fixed-stack.10)
    ; SAVEALL-AIX: STD killed $x22, -80, $x1 :: (store (s64) into %fixed-stack.9, align 16)
    ; SAVEALL-AIX: STD killed $x23, -72, $x1 :: (store (s64) into %fixed-stack.8)
    ; SAVEALL-AIX: STD killed $x24, -64, $x1 :: (store (s64) into %fixed-stack.7, align 16)
    ; SAVEALL-AIX: STD killed $x25, -56, $x1 :: (store (s64) into %fixed-stack.6)
    ; SAVEALL-AIX: STD killed $x26, -48, $x1 :: (store (s64) into %fixed-stack.5, align 16)
    ; SAVEALL-AIX: STD killed $x27, -40, $x1 :: (store (s64) into %fixed-stack.4)
    ; SAVEALL-AIX: STD killed $x28, -32, $x1 :: (store (s64) into %fixed-stack.3, align 16)
    ; SAVEALL-AIX: STD killed $x29, -24, $x1 :: (store (s64) into %fixed-stack.2)
    ; SAVEALL-AIX: STD killed $x30, -16, $x1 :: (store (s64) into %fixed-stack.1, align 16)
    ; SAVEALL-AIX: STD killed $x31, -8, $x1 :: (store (s64) into %fixed-stack.0)
    ; SAVEALL-AIX: renamable $x14 = ANDI8_rec killed renamable $x3, 1, implicit-def dead $cr0, implicit-def $cr0gt
    ; SAVEALL-AIX: renamable $cr2lt = COPY $cr0gt
    ; SAVEALL-AIX: renamable $x3 = COPY $x14
    ; SAVEALL-AIX: $x31 = LD -8, $x1 :: (load (s64) from %fixed-stack.0)
    ; SAVEALL-AIX: $x30 = LD -16, $x1 :: (load (s64) from %fixed-stack.1, align 16)
    ; SAVEALL-AIX: $x29 = LD -24, $x1 :: (load (s64) from %fixed-stack.2)
    ; SAVEALL-AIX: $x28 = LD -32, $x1 :: (load (s64) from %fixed-stack.3, align 16)
    ; SAVEALL-AIX: $x27 = LD -40, $x1 :: (load (s64) from %fixed-stack.4)
    ; SAVEALL-AIX: $x26 = LD -48, $x1 :: (load (s64) from %fixed-stack.5, align 16)
    ; SAVEALL-AIX: $x25 = LD -56, $x1 :: (load (s64) from %fixed-stack.6)
    ; SAVEALL-AIX: $x24 = LD -64, $x1 :: (load (s64) from %fixed-stack.7, align 16)
    ; SAVEALL-AIX: $x23 = LD -72, $x1 :: (load (s64) from %fixed-stack.8)
    ; SAVEALL-AIX: $x22 = LD -80, $x1 :: (load (s64) from %fixed-stack.9, align 16)
    ; SAVEALL-AIX: $x21 = LD -88, $x1 :: (load (s64) from %fixed-stack.10)
    ; SAVEALL-AIX: $x20 = LD -96, $x1 :: (load (s64) from %fixed-stack.11, align 16)
    ; SAVEALL-AIX: $x19 = LD -104, $x1 :: (load (s64) from %fixed-stack.12)
    ; SAVEALL-AIX: $x18 = LD -112, $x1 :: (load (s64) from %fixed-stack.13, align 16)
    ; SAVEALL-AIX: $x17 = LD -120, $x1 :: (load (s64) from %fixed-stack.14)
    ; SAVEALL-AIX: $x16 = LD -128, $x1 :: (load (s64) from %fixed-stack.15, align 16)
    ; SAVEALL-AIX: $x15 = LD -136, $x1 :: (load (s64) from %fixed-stack.16)
    ; SAVEALL-AIX: $x14 = LD -144, $x1 :: (load (s64) from %fixed-stack.17, align 16)
    ; SAVEALL-AIX: $x12 = LWZ8 8, $x1
    ; SAVEALL-AIX: $cr2 = MTOCRF8 killed $x12
    ; SAVEALL-AIX: BLR8 implicit $lr8, implicit $rm, implicit $x3
    renamable $x14 = ANDI8_rec killed renamable $x3, 1, implicit-def dead $cr0, implicit-def $cr0gt
    renamable $cr2lt = COPY $cr0gt
    renamable $x3 = COPY $x14
    BLR8 implicit $lr8, implicit $rm, implicit $x3

    ; CHECK-LABEL: CR2Save

    ; CHECK-LABEL: fixedStack:
    ; CHECK-NEXT:   - { id: 0, type: spill-slot, offset: -144, size: 8, alignment: 16, stack-id: default,
    ; CHECK-NEXT:       callee-saved-register: '$x14', callee-saved-restored: true, debug-info-variable: '',
    ; CHECK-NEXT:       debug-info-expression: '', debug-info-location: '' }
    ; CHECK-NEXT:   - { id: 1, type: default, offset: 8, size: 4, alignment: 8, stack-id: default,
    ; CHECK-NEXT:       isImmutable: true, isAliased: false, callee-saved-register: '$cr2',
    ; CHECK-NEXT:       callee-saved-restored: true, debug-info-variable: '', debug-info-expression: '',
    ; CHECK-NEXT:       debug-info-location: '' }
    ; CHECK-LABEL:  stack:

    ; Verify the proper live-ins have been added in the prologue.
    ; CHECK:    liveins: $x3, $x14, $cr2

    ; ELF V2 ABI allows saving only the clobbered cr fields,
    ; whereas the other ABIs do not.

    ; CHECK-DAG: STD killed $x14, -144, $x1 :: (store (s64) into %fixed-stack.0, align 16)
    ; CHECK-DAG: STW8 killed $x12, 8, $x1

    ; CHECK:     $x14 = LD -144, $x1 :: (load (s64) from %fixed-stack.0, align 16)
    ; CHECK:     $x12 = LWZ8 8, $x1
    ; CHECK:     $cr2 = MTOCRF8 killed $x12


...

