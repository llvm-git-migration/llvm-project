; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt -passes=lower-constant-intrinsics -S < %s | FileCheck %s

target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

declare i64 @llvm.objectsize.i64.p0(ptr, i1 immarg, i1 immarg, i1 immarg)
declare noalias ptr @malloc(i64 noundef) #0

define i64 @select_alloc_size(i1 %cond) {
; CHECK-LABEL: @select_alloc_size(
; CHECK-NEXT:    [[SIZE:%.*]] = select i1 [[COND:%.*]], i64 3, i64 4
; CHECK-NEXT:    [[PTR:%.*]] = alloca i8, i64 [[SIZE]], align 1
; CHECK-NEXT:    [[RES:%.*]] = select i1 [[COND]], i64 4, i64 3
; CHECK-NEXT:    ret i64 [[RES]]
;
  %size = select i1 %cond, i64 3, i64 4
  %ptr = alloca i8, i64 %size
  %objsize_max = call i64 @llvm.objectsize.i64.p0(ptr %ptr, i1 false, i1 true, i1 false)
  %objsize_min = call i64 @llvm.objectsize.i64.p0(ptr %ptr, i1 true, i1 true, i1 false)
  %res = select i1 %cond, i64 %objsize_max, i64 %objsize_min
  ret i64 %res
}

define i64 @select_malloc_size(i1 %cond) {
; CHECK-LABEL: @select_malloc_size(
; CHECK-NEXT:    [[SIZE:%.*]] = select i1 [[COND:%.*]], i64 3, i64 4
; CHECK-NEXT:    [[PTR:%.*]] = call noalias ptr @malloc(i64 noundef [[SIZE]])
; CHECK-NEXT:    [[RES:%.*]] = select i1 [[COND]], i64 4, i64 3
; CHECK-NEXT:    ret i64 [[RES]]
;
  %size = select i1 %cond, i64 3, i64 4
  %ptr = call noalias ptr @malloc(i64 noundef %size)
  %objsize_max = call i64 @llvm.objectsize.i64.p0(ptr %ptr, i1 false, i1 true, i1 false)
  %objsize_min = call i64 @llvm.objectsize.i64.p0(ptr %ptr, i1 true, i1 true, i1 false)
  %res = select i1 %cond, i64 %objsize_max, i64 %objsize_min
  ret i64 %res
}

define i64 @phi_malloc_size(i1 %cond, i64 %size) {
; CHECK-LABEL: @phi_malloc_size(
; CHECK-NEXT:  entry:
; CHECK-NEXT:    [[SHIFTED:%.*]] = add i64 [[SIZE:%.*]], -11
; CHECK-NEXT:    [[CMP:%.*]] = icmp ult i64 [[SHIFTED]], -8
; CHECK-NEXT:    br i1 [[CMP]], label [[RETURN:%.*]], label [[IF_END:%.*]]
; CHECK:       if.end:
; CHECK-NEXT:    [[MEM:%.*]] = tail call noalias ptr @malloc(i64 noundef [[SIZE]])
; CHECK-NEXT:    [[RES1:%.*]] = select i1 [[COND:%.*]], i64 10, i64 3
; CHECK-NEXT:    br label [[RETURN]]
; CHECK:       return:
; CHECK-NEXT:    [[RES:%.*]] = phi i64 [ [[RES1]], [[IF_END]] ], [ -1, [[ENTRY:%.*]] ]
; CHECK-NEXT:    ret i64 [[RES]]
;
entry:
  %shifted = add i64 %size, -11
  %valid = icmp ult i64 %shifted, -8
  br i1 %valid, label %return, label %if.end

if.end:
  %ptr = tail call noalias ptr @malloc(i64 noundef %size)
  %objsize_max = call i64 @llvm.objectsize.i64.p0(ptr %ptr, i1 false, i1 false, i1 false)
  %objsize_min = call i64 @llvm.objectsize.i64.p0(ptr %ptr, i1 true, i1 false, i1 false)
  %res = select i1 %cond, i64 %objsize_max, i64 %objsize_min
  br label %return

return:
  %res.phi = phi i64 [%res, %if.end], [-1, %entry]
  ret i64 %res.phi
}

define i64 @select_gep_offset(i1 %cond) {
; CHECK-LABEL: @select_gep_offset(
; CHECK-NEXT:    [[PTR:%.*]] = alloca i8, i64 10, align 1
; CHECK-NEXT:    [[OFFSET:%.*]] = select i1 [[COND:%.*]], i64 3, i64 4
; CHECK-NEXT:    [[PTR_SLIDE:%.*]] = getelementptr inbounds i8, ptr [[PTR]], i64 [[OFFSET]]
; CHECK-NEXT:    [[RES:%.*]] = select i1 [[COND]], i64 7, i64 6
; CHECK-NEXT:    ret i64 [[RES]]
;
  %ptr = alloca i8, i64 10
  %offset = select i1 %cond, i64 3, i64 4
  %ptr.slide = getelementptr inbounds i8, ptr %ptr, i64 %offset
  %objsize_max = call i64 @llvm.objectsize.i64.p0(ptr %ptr.slide, i1 false, i1 true, i1 false)
  %objsize_min = call i64 @llvm.objectsize.i64.p0(ptr %ptr.slide, i1 true, i1 true, i1 false)
  %res = select i1 %cond, i64 %objsize_max, i64 %objsize_min
  ret i64 %res
}

define i64 @select_gep_neg_offset(i1 %cond) {
; CHECK-LABEL: @select_gep_neg_offset(
; CHECK-NEXT:    [[PTR:%.*]] = alloca i8, i64 10, align 1
; CHECK-NEXT:    [[PTR_SLIDE_1:%.*]] = getelementptr inbounds i8, ptr [[PTR]], i64 5
; CHECK-NEXT:    [[OFFSET:%.*]] = select i1 [[COND:%.*]], i64 -3, i64 -4
; CHECK-NEXT:    [[PTR_SLIDE_2:%.*]] = getelementptr inbounds i8, ptr [[PTR_SLIDE_1]], i64 [[OFFSET]]
; CHECK-NEXT:    [[RES:%.*]] = select i1 [[COND]], i64 9, i64 8
; CHECK-NEXT:    ret i64 [[RES]]
;
  %ptr = alloca i8, i64 10
  %ptr.slide.1 = getelementptr inbounds i8, ptr %ptr, i64 5
  %offset = select i1 %cond, i64 -3, i64 -4
  %ptr.slide.2 = getelementptr inbounds i8, ptr %ptr.slide.1, i64 %offset
  %objsize_max = call i64 @llvm.objectsize.i64.p0(ptr %ptr.slide.2, i1 false, i1 true, i1 false)
  %objsize_min = call i64 @llvm.objectsize.i64.p0(ptr %ptr.slide.2, i1 true, i1 true, i1 false)
  %res = select i1 %cond, i64 %objsize_max, i64 %objsize_min
  ret i64 %res
}

attributes #0 = { nounwind allocsize(0) }
