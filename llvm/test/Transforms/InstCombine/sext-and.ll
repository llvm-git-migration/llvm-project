; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt < %s -passes=instcombine -S | FileCheck %s

declare void @use(i8)

define i1 @fold_sext_to_and(i8 %x) {
; CHECK-LABEL: define i1 @fold_sext_to_and(
; CHECK-SAME: i8 [[X:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sext i8 [[X]] to i32
; CHECK-NEXT:    [[TMP2:%.*]] = and i32 [[TMP1]], -2147483647
; CHECK-NEXT:    [[TMP3:%.*]] = icmp eq i32 [[TMP2]], 1
; CHECK-NEXT:    ret i1 [[TMP3]]
;
  %1 = sext i8 %x to i32
  %2 = and i32 %1, -2147483647
  %3 = icmp eq i32 %2, 1
  ret i1 %3
}

define i1 @fold_sext_to_and_multi_use(i8 %x) {
; CHECK-LABEL: define i1 @fold_sext_to_and_multi_use(
; CHECK-SAME: i8 [[X:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sext i8 [[X]] to i32
; CHECK-NEXT:    call void @use(i32 [[TMP1]])
; CHECK-NEXT:    [[TMP2:%.*]] = and i32 [[TMP1]], -2147483647
; CHECK-NEXT:    [[TMP3:%.*]] = icmp eq i32 [[TMP2]], 1
; CHECK-NEXT:    ret i1 [[TMP3]]
;
  %1 = sext i8 %x to i32
  call void @use(i32 %1)
  %2 = and i32 %1, -2147483647
  %3 = icmp eq i32 %2, 1
  ret i1 %3
}

; Negative tests

define i1 @fold_sext_to_and_wrong(i2 %x) {
; CHECK-LABEL: define i1 @fold_sext_to_and_wrong(
; CHECK-SAME: i2 [[X:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sext i2 [[X]] to i32
; CHECK-NEXT:    [[TMP2:%.*]] = and i32 [[TMP1]], -2147483647
; CHECK-NEXT:    [[TMP3:%.*]] = icmp eq i32 [[TMP2]], 1
; CHECK-NEXT:    ret i1 [[TMP3]]
;
  %1 = sext i2 %x to i32
  %2 = and i32 %1, -2147483647
  %3 = icmp eq i32 %2, 1
  ret i1 %3
}
